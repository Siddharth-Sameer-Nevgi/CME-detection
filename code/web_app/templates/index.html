<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolarWatch | Aditya-L1 Mission Control</title>
    
    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Plotly.js for Scientific Charts -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-orange: #f97316;
            --accent-green: #22c55e;
        }
        
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-primary); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background-color: #0f172a !important;
            border-bottom: 1px solid #334155;
        }
        
        .card { 
            background-color: var(--card-bg); 
            border: 1px solid #334155; 
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px; 
        }
        
        .metric-value { font-size: 2rem; font-weight: 700; }
        .metric-label { color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-safe { background-color: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid #22c55e; }
        .status-danger { background-color: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid #ef4444; }
        
        /* Table Styling */
        .table-dark { background-color: transparent; }
        .table-dark th { color: var(--text-secondary); border-bottom: 1px solid #475569; }
        .table-dark td { border-bottom: 1px solid #334155; vertical-align: middle; }
        
        /* Loading Overlay */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }
    </style>
</head>
<body>

<!-- Loading Spinner -->
<div id="loading">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="mt-3">Acquiring Telemetry...</div>
    </div>
</div>

<!-- Navbar -->
<nav class="navbar navbar-dark sticky-top px-4">
    <div class="d-flex align-items-center">
        <i class="bi bi-sun-fill text-warning fs-3 me-2"></i>
        <span class="navbar-brand mb-0 h1 fw-bold">SolarWatch <span class="text-muted fw-light">| Aditya-L1 Mission Control</span></span>
    </div>
    <div>
        <span class="text-secondary me-3"><i class="bi bi-clock"></i> <span id="last-updated">--:--:--</span></span>
        <span id="system-status" class="status-badge status-safe"><i class="bi bi-check-circle-fill"></i> Nominal</span>
    </div>
</nav>

<div class="container-fluid px-4 mt-4">
    
    <!-- Top Metrics Row -->
    <div class="row">
        <div class="col-md-3">
            <div class="card p-3">
                <div class="metric-label">Max Proton Speed</div>
                <div class="metric-value text-danger"><span id="max-speed">--</span> <span class="fs-6 text-muted">km/s</span></div>
                <div class="text-secondary small"><i class="bi bi-speedometer2"></i> Peak Velocity</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3">
                <div class="metric-label">Max Density</div>
                <div class="metric-value text-primary"><span id="max-density">--</span> <span class="fs-6 text-muted">#/cm³</span></div>
                <div class="text-secondary small"><i class="bi bi-grid-3x3"></i> Particle Concentration</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3">
                <div class="metric-label">Alpha Ratio</div>
                <div class="metric-value text-warning"><span id="max-alpha">--</span> <span class="fs-6 text-muted">%</span></div>
                <div class="text-secondary small"><i class="bi bi-radioactive"></i> Helium Composition</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3">
                <div class="metric-label">Events Detected</div>
                <div class="metric-value text-white"><span id="event-count">0</span></div>
                <div class="text-secondary small"><i class="bi bi-exclamation-triangle"></i> CME Anomalies</div>
            </div>
        </div>
    </div>

    <!-- Main Charts Row -->
    <div class="row">
        <!-- Solar Wind Speed & Density Chart -->
        <div class="col-lg-8">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Solar Wind Plasma Parameters</h5>
                    <div class="btn-group btn-group-sm">
                        <button id="btn-24h" class="btn btn-outline-secondary" onclick="setTimeRange('24h')">24h</button>
                        <button id="btn-7d" class="btn btn-outline-secondary active" onclick="setTimeRange('7d')">7d</button>
                        <button id="btn-30d" class="btn btn-outline-secondary" onclick="setTimeRange('30d')">30d</button>
                        <button id="btn-all" class="btn btn-outline-secondary" onclick="setTimeRange('all')">All</button>
                    </div>
                </div>
                <div id="plasmaChart" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Composition & Temp Chart -->
        <div class="col-lg-4">
            <div class="card p-3">
                <h5 class="mb-3"><i class="bi bi-thermometer-half"></i> Composition & Temp</h5>
                <div id="compChart" style="height: 190px; margin-bottom: 20px;"></div>
                <div id="tempChart" style="height: 190px;"></div>
            </div>
        </div>
    </div>

    <!-- Alerts Table Row -->
    <div class="row">
        <div class="col-12">
            <div class="card p-3">
                <h5 class="mb-3"><i class="bi bi-list-ul"></i> Mission Log & Anomalies</h5>
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Timestamp (UTC)</th>
                                <th>Severity</th>
                                <th>Event Details</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="alert-table-body">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const PLOT_BG = '#1e293b';
    const PAPER_BG = '#1e293b';
    const TEXT_COLOR = '#94a3b8';
    const GRID_COLOR = '#334155';
    
    let datasetMaxDate = null;
    let datasetMinDate = null;

    document.addEventListener('DOMContentLoaded', () => {
        initDashboard();
    });

    async function initDashboard() {
        try {
            // 1. Get Metadata (Min/Max Dates)
            const metaRes = await fetch('/api/metadata');
            const meta = await metaRes.json();
            datasetMaxDate = new Date(meta.max_date);
            datasetMinDate = new Date(meta.min_date);
            
            // 2. Load Initial Data (Default: Last 7 Days of available data)
            await setTimeRange('7d');
            
            // 3. Load Alerts
            await loadAlerts();
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('last-updated').innerText = new Date().toLocaleTimeString();
        } catch (error) {
            console.error("Dashboard Init Failed:", error);
            alert("Failed to load telemetry data.");
        }
    }
    
    async function setTimeRange(range) {
        if (!datasetMaxDate) return;
        
        // Update Buttons UI
        document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${range}`).classList.add('active');
        
        let start = new Date(datasetMaxDate);
        let end = new Date(datasetMaxDate);
        
        if (range === '24h') {
            start.setHours(start.getHours() - 24);
        } else if (range === '7d') {
            start.setDate(start.getDate() - 7);
        } else if (range === '30d') {
            start.setDate(start.getDate() - 30);
        } else if (range === 'all') {
            start = new Date(datasetMinDate);
        }
        
        // Format for API (Full ISO String to keep precision)
        const startStr = start.toISOString();
        const endStr = end.toISOString(); 
        
        await loadTelemetry(startStr, endStr);
    }

    async function loadTelemetry(start, end) {
        // Show loading state if needed
        const response = await fetch(`/api/telemetry?start=${start}&end=${end}`);
        const data = await response.json();

        if (data.length === 0) {
            console.warn("No data for this range");
            return;
        }

        // Prepare Data Arrays
        const times = data.map(d => d.observation_time);
        const speeds = data.map(d => d.proton_speed);
        const densities = data.map(d => d.proton_density);
        const temps = data.map(d => d.proton_thermal_speed);
        const alphaRatios = data.map(d => d.alpha_ratio * 100); // Convert to %

        // Update Summary Metrics (Based on visible data)
        document.getElementById('max-speed').innerText = Math.max(...speeds).toFixed(0);
        document.getElementById('max-density').innerText = Math.max(...densities).toFixed(1);
        document.getElementById('max-alpha').innerText = Math.max(...alphaRatios).toFixed(1);

        // --- CHART 1: Speed vs Density (Dual Axis) ---
        const traceSpeed = {
            x: times, y: speeds,
            name: 'Proton Speed (km/s)',
            type: 'scatter', mode: 'lines',
            line: { color: '#ef4444', width: 2 }
        };

        const traceDensity = {
            x: times, y: densities,
            name: 'Density (#/cm³)',
            yaxis: 'y2',
            type: 'scatter', mode: 'lines',
            fill: 'tozeroy',
            line: { color: '#3b82f6', width: 1 }
        };

        const layoutPlasma = {
            paper_bgcolor: PAPER_BG, plot_bgcolor: PLOT_BG,
            font: { color: TEXT_COLOR },
            margin: { t: 10, l: 50, r: 50, b: 40 },
            xaxis: { gridcolor: GRID_COLOR, showgrid: false },
            yaxis: { 
                title: 'Speed (km/s)', 
                gridcolor: GRID_COLOR,
                titlefont: { color: '#ef4444' },
                tickfont: { color: '#ef4444' }
            },
            yaxis2: {
                title: 'Density (#/cm³)',
                overlaying: 'y', side: 'right',
                gridcolor: GRID_COLOR,
                titlefont: { color: '#3b82f6' },
                tickfont: { color: '#3b82f6' }
            },
            legend: { orientation: 'h', y: 1.1 }
        };

        Plotly.newPlot('plasmaChart', [traceDensity, traceSpeed], layoutPlasma, {responsive: true});

        // --- CHART 2: Alpha Ratio ---
        const traceAlpha = {
            x: times, y: alphaRatios,
            name: 'Alpha Ratio (%)',
            type: 'scatter', mode: 'lines',
            line: { color: '#f97316', width: 2 }
        };
        
        const layoutComp = {
            title: { text: 'Alpha/Proton Ratio (%)', font: { size: 12, color: TEXT_COLOR } },
            paper_bgcolor: PAPER_BG, plot_bgcolor: PLOT_BG,
            font: { color: TEXT_COLOR },
            margin: { t: 30, l: 40, r: 20, b: 30 },
            xaxis: { showticklabels: false, gridcolor: GRID_COLOR },
            yaxis: { gridcolor: GRID_COLOR }
        };
        
        Plotly.newPlot('compChart', [traceAlpha], layoutComp, {responsive: true});

        // --- CHART 3: Temperature ---
        const traceTemp = {
            x: times, y: temps,
            name: 'Thermal Speed (km/s)',
            type: 'scatter', mode: 'lines',
            line: { color: '#22c55e', width: 1.5 }
        };

        const layoutTemp = {
            title: { text: 'Proton Thermal Speed (km/s)', font: { size: 12, color: TEXT_COLOR } },
            paper_bgcolor: PAPER_BG, plot_bgcolor: PLOT_BG,
            font: { color: TEXT_COLOR },
            margin: { t: 30, l: 40, r: 20, b: 30 },
            xaxis: { gridcolor: GRID_COLOR },
            yaxis: { gridcolor: GRID_COLOR }
        };

        Plotly.newPlot('tempChart', [traceTemp], layoutTemp, {responsive: true});
    }
    
    // Function to Zoom into an Event
    async function analyzeEvent(startTime, endTime) {
        // Add a small buffer (e.g., 6 hours) around the event for context
        const start = new Date(startTime);
        start.setHours(start.getHours() - 6);
        
        const end = new Date(endTime);
        end.setHours(end.getHours() + 6);
        
        // Format for API
        const startStr = start.toISOString();
        const endStr = end.toISOString();
        
        // 1. Load the specific data for this event from the server
        await loadTelemetry(startStr, endStr);
        
        // 2. Update Buttons UI to show we are in a custom mode
        document.querySelectorAll('.btn-group button').forEach(b => b.classList.remove('active'));
        
        // 3. Scroll to top to see the graph
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function loadAlerts() {
        const response = await fetch('/api/alerts');
        const alerts = await response.json();

        document.getElementById('event-count').innerText = alerts.length;
        const tableBody = document.getElementById('alert-table-body');
        
        // Update System Status based on recent alerts
        if (alerts.length > 0) {
            const statusBadge = document.getElementById('system-status');
            statusBadge.className = 'status-badge status-danger';
            statusBadge.innerHTML = '<i class="bi bi-exclamation-circle-fill"></i> ALERT ACTIVE';
        }

        alerts.forEach(alert => {
            const date = new Date(alert.generated_at).toLocaleString();
            const badgeClass = alert.severity === 'HIGH' ? 'bg-danger' : 'bg-warning text-dark';
            
            // Pass the raw timestamp to the analyze function
            const row = `
                <tr>
                    <td><span class="text-white fw-bold">${date}</span></td>
                    <td><span class="badge ${badgeClass}">${alert.severity}</span></td>
                    <td>${alert.message}</td>
                    <td><button class="btn btn-sm btn-outline-light" onclick="analyzeEvent('${alert.generated_at}', '${alert.end_time}')"><i class="bi bi-search"></i> Analyze</button></td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }
</script>

</body>
</html>